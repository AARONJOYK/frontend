deploy:
  needs: build-and-push
  runs-on: ubuntu-latest
  steps:
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no aaronjoy@${{ secrets.SERVER_IP }} '
          echo "Stopping existing containers..."
          sudo docker-compose down
          echo "Removing old images..."
          sudo docker system prune -af
          echo "Pulling new images..."
          sudo docker-compose pull
          echo "Starting new containers..."
          sudo docker-compose up -d --force-recreate
          echo "Deployment complete!"
        '
